# RegisterFeed å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦PASSã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã§å®Ÿè£…å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

## âœ… ãƒ†ã‚¹ãƒˆä¸€è¦§ï¼ˆå…¨14ãƒ†ã‚¹ãƒˆ - å…¨ã¦PASSï¼‰

### URLæ­£è¦åŒ–ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ4ãƒ†ã‚¹ãƒˆï¼‰
- [x] `æ­£å¸¸ç³»: æ­£ã—ã„HTTPS URLãŒæ­£è¦åŒ–ã•ã‚Œã‚‹` - ã‚¹ãƒšãƒ¼ã‚¹ã®å‰Šé™¤ãƒ»URLæ­£è¦åŒ–
- [x] `ç•°å¸¸ç³»: ç©ºæ–‡å­—åˆ—ã¯InvalidFeedUrlErrorã‚’ã‚¹ãƒ­ãƒ¼` - å…¥åŠ›æ¤œè¨¼
- [x] `ç•°å¸¸ç³»: HTTPSã§ãªã„ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¯InvalidFeedUrlErrorã‚’ã‚¹ãƒ­ãƒ¼` - ãƒ—ãƒ­ãƒˆã‚³ãƒ«æ¤œè¨¼
- [x] `ç•°å¸¸ç³»: ä¸æ­£ãªURLã¯InvalidFeedUrlErrorã‚’ã‚¹ãƒ­ãƒ¼` - URLå½¢å¼æ¤œè¨¼

### ãƒ•ã‚£ãƒ¼ãƒ‰ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ2ãƒ†ã‚¹ãƒˆï¼‰
- [x] `æ­£å¸¸ç³»: åŒã˜URLã®ãƒ•ã‚£ãƒ¼ãƒ‰ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯å†åˆ©ç”¨ã•ã‚Œã‚‹` - æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ‰æ¤œç´¢
- [x] `æ­£å¸¸ç³»: URLãŒæœªç™»éŒ²ã®å ´åˆã€ãƒ•ã‚£ãƒ¼ãƒ‰ãŒæ–°è¦ä½œæˆã•ã‚Œã‚‹` - æ–°è¦ãƒ•ã‚£ãƒ¼ãƒ‰ä½œæˆ

### å·®åˆ†å–å¾—ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ2ãƒ†ã‚¹ãƒˆï¼‰
- [x] `æ­£å¸¸ç³»: DBã«è¨˜äº‹ãŒãªã„å ´åˆã€ETag/Last-ModifiedãŒç„¡è¦–ã•ã‚Œã‚‹ï¼ˆå…¨ä»¶å–å¾—ï¼‰` - DBç©ºæ™‚ã®æˆ¦ç•¥
- [x] `æ­£å¸¸ç³»: DBã«è¨˜äº‹ãŒã‚ã‚‹å ´åˆã€ETag/Last-ModifiedãŒä½¿ã‚ã‚Œã‚‹` - DBéç©ºæ™‚ã®æˆ¦ç•¥

### 304å¿œç­”ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ1ãƒ†ã‚¹ãƒˆï¼‰
- [x] `æ­£å¸¸ç³»: fetched.notModified=true ã®å ´åˆã€è¨˜äº‹ã¯ä¿å­˜ã•ã‚Œãªã„` - å·®åˆ†ãªã—åˆ¤å®š

### è¨˜äº‹ç®¡ç†ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ2ãƒ†ã‚¹ãƒˆï¼‰
- [x] `æ­£å¸¸ç³»: æ–°è¦è¨˜äº‹ãŒã‚ã‚‹å ´åˆã€ä¿å­˜ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆãŒè¡Œã‚ã‚Œã‚‹` - è¨˜äº‹ä¿å­˜ï¼‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- [x] `æ­£å¸¸ç³»: è¨˜äº‹ãŒ0ä»¶ã®å ´åˆã€ä¿å­˜ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã¯è¡Œã‚ã‚Œãªã„` - è¨˜äº‹ãªã—ã®åˆ¤å®š

### ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ1ãƒ†ã‚¹ãƒˆï¼‰
- [x] `æ­£å¸¸ç³»: ãƒ•ã‚£ãƒ¼ãƒ‰å–å¾—å¾Œã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã‚‹` - æ¬¡å›å·®åˆ†å–å¾—ã®æº–å‚™

### è³¼èª­ä½œæˆã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆ2ãƒ†ã‚¹ãƒˆï¼‰
- [x] `æ­£å¸¸ç³»: ãƒ¦ãƒ¼ã‚¶ãƒ¼è³¼èª­ãŒä½œæˆã•ã‚Œã‚‹ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ãªã—ï¼‰` - è³¼èª­ä½œæˆï¼ˆãƒ•ã‚©ãƒ«ãƒ€ãªã—ï¼‰
- [x] `æ­£å¸¸ç³»: ãƒ¦ãƒ¼ã‚¶ãƒ¼è³¼èª­ãŒä½œæˆã•ã‚Œã‚‹ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã‚ã‚Šï¼‰` - è³¼èª­ä½œæˆï¼ˆãƒ•ã‚©ãƒ«ãƒ€ã‚ã‚Šï¼‰

---

## ğŸ” å®Ÿè£…å†…å®¹ã®ç¢ºèªæ–¹æ³•

### æ–¹æ³•1: ãƒ†ã‚¹ãƒˆã‚’èª­ã‚“ã§ã‹ã‚‰å®Ÿè£…ã‚’ç¢ºèª
```bash
# ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ç¢ºèª
vi src/application/use-cases/__tests__/register-feed.test.ts

# å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ç¢ºèª
vi src/application/use-cases/register-feed.ts
```

### æ–¹æ³•2: å€‹åˆ¥ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
```bash
# ç‰¹å®šã®ã‚°ãƒ«ãƒ¼ãƒ—ã ã‘ã‚’å®Ÿè¡Œ
npm test src/application/use-cases/__tests__/register-feed.test.ts -- -t "URLæ­£è¦åŒ–"

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã ã‘ã‚’å®Ÿè¡Œ
npm test src/application/use-cases/__tests__/register-feed.test.ts -- -t "æ­£å¸¸ç³»: åŒã˜URLã®ãƒ•ã‚£ãƒ¼ãƒ‰"
```

### æ–¹æ³•3: ãƒ‡ãƒãƒƒã‚°ã—ãªãŒã‚‰ç¢ºèª
```bash
# Watch ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã«è‡ªå‹•å®Ÿè¡Œï¼‰
npm test -- --watch src/application/use-cases/__tests__/register-feed.test.ts
```

---

## ğŸ“š å­¦ç¿’ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³

### ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ç†è§£
1. **ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’èª­ã‚€** â†’ [implementation-guide-register-feed.md](../implementation-guide-register-feed.md)
2. **ãƒ†ã‚¹ãƒˆã‹ã‚‰ä»•æ§˜ã‚’ç†è§£** â†’ `src/application/use-cases/__tests__/register-feed.test.ts`
3. **å®Ÿè£…ã‚’ç¢ºèª** â†’ `src/application/use-cases/register-feed.ts`
4. **ä»–ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¨æ¯”è¼ƒ** â†’ `mark-entry-read.ts` ãªã©ã¨æ¯”è¼ƒ

### ãƒ†ã‚¹ãƒˆã‚’èª­ã‚€ã¨ãã®Tips
- **Arrangeéƒ¨åˆ†**: ãƒ¢ãƒƒã‚¯è¨­å®šï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒã®ç”¨æ„ï¼‰
- **Actéƒ¨åˆ†**: å®Ÿéš›ã®é–¢æ•°å‘¼ã³å‡ºã—
- **Assertéƒ¨åˆ†**: æœŸå¾…å€¤ã®æ¤œè¨¼

ä¾‹:
```typescript
it("ãƒ†ã‚¹ãƒˆèª¬æ˜", async () => {
  // â”€â”€ Arrangeï¼ˆæº–å‚™ï¼‰â”€â”€ 
  const deps = createMockDeps();
  (deps.xxx as ReturnType<typeof vi.fn>).mockResolvedValue(...);
  
  // â”€â”€ Actï¼ˆå®Ÿè¡Œï¼‰â”€â”€
  const result = await useCase.execute(...);
  
  // â”€â”€ Assertï¼ˆæ¤œè¨¼ï¼‰â”€â”€
  expect(result).toBe(...);
  expect(deps.xxx).toHaveBeenCalledWith(...);
});
```

---

## ğŸ¯ å®Ÿè£…ã‚¬ã‚¤ãƒ‰ã®ä¸»è¦ãƒã‚¤ãƒ³ãƒˆ

### å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆ6ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
| ã‚¹ãƒ†ãƒƒãƒ— | å½¹å‰² | ä¸»è¦é–¢æ•° |
|---------|------|--------|
| 1 | URLæ­£è¦åŒ–ï¼†æ¤œè¨¼ | `normalizeUrl()` |
| 2 | æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ‰ç¢ºèª or æ–°è¦ä½œæˆ | `findByUrl()` / `create()` |
| 3 | DBçŠ¶æ…‹ã«å¿œã˜ãŸå·®åˆ†å–å¾—æˆ¦ç•¥ | `listByFilter()` / `fetchFeed()` |
| 4 | è¨˜äº‹ã®ä¿å­˜ï¼†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ | `saveFetchedEntries()` / `indexEntries()` |
| 5 | ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–° | `updateFetchMetadata()` |
| 6 | ãƒ¦ãƒ¼ã‚¶ãƒ¼è³¼èª­ä½œæˆ | `createSubscription()` |

### ã‚ˆãã‚ã‚‹ãƒŸã‚¹
```typescript
// âŒ é–“é•ã„
const fetched = await this.deps.rssFetcher.fetchFeed({
  url: feed.url,
  etag: feed.etag, // DBç©ºã§ã‚‚å¸¸ã«æ¸¡ã—ã¦ã—ã¾ã†
});

// âœ… æ­£ã—ã„
const fetched = await this.deps.rssFetcher.fetchFeed({
  url: feed.url,
  etag: isDbEmpty ? undefined : feed.etag, // DBç©ºãªã‚‰ undefined
});
```

---

## ğŸš€ æ¬¡ã¸é€²ã‚€ãŸã‚ã®å‚è€ƒè³‡æ–™

- **ä»–ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ**: 
  - `mark-entry-read.test.ts` - ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ã‚¹ãƒˆä¾‹
  - `sync-feeds.test.ts` - è¤‡é›‘ãªæ¡ä»¶åˆ†å²ã®ãƒ†ã‚¹ãƒˆä¾‹
  
- **ãƒãƒ¼ãƒˆã®å®šç¾©**:
  - `application/ports/index.ts` - ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

- **ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«**:
  - `domain/entities/feed.ts` - Feed ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
  - `domain/entities/subscription.ts` - Subscription ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

---

## ğŸ’¬ è³ªå•ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

å®Ÿè£…ã§ã‚ã‹ã‚‰ãªã„ã“ã¨ãŒã‚ã‚Œã°ã€ã“ã®é †åºã§è³ªå•ã—ã¦ãã ã•ã„ï¼š

1. **ã€Œãƒ†ã‚¹ãƒˆã€‡ã€‡ãŒå¤±æ•—ã—ã¦ã¾ã™ã€**  
   â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…±æœ‰

2. **ã€Œã‚¹ãƒ†ãƒƒãƒ—2ã®å‡¦ç†ãŒã‚ã‹ã‚Šã¾ã›ã‚“ã€**  
   â†’ è©²å½“éƒ¨åˆ†ã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª

3. **ã€Œãƒ¢ãƒƒã‚¯ã®æ›¸ãæ–¹ãŒã‚ã‹ã‚Šã¾ã›ã‚“ã€**  
   â†’ `mark-entry-read.test.ts` ã¨ã®æ¯”è¼ƒ

